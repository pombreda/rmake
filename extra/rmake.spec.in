%define __python %{_bindir}/python2.4
%define python_sitelib %(%{__python} -c "from distutils.sysconfig import get_python_lib; print get_python_lib()")

%if "%{?rhel}" == "3" || "%{?rhel}" == "4"
%define python python24
%else
%define python python
%endif

Summary: rMake is a tool for building software using Conary in a simple, controlled way.
Name: rmake
Version: @version@
Release: 1%{?dist}
License: CPL
Group: System Environment/Base
URL: http://wiki.conary.com/
Source0: %{name}-%{version}.tar.bz2
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root
BuildRequires: %{python} >= 2.4
BuildRequires: libcap-devel
Requires: %{python} >= 2.4
Requires: sqlite >= 3.2.1
Requires: conary >= 1.0.21
Requires: conary-repository >= 1.0.21
PreReq: /usr/sbin/useradd, /sbin/chkconfig

%define pythonlib %{python_sitelib}/%{name}

%description
rMake handles build jobs using the conary packaging system. rMake
automatically creates a fresh clean build chroot with everything a
package needs to build according to its specific build
requirements. Before rMake, you had to install the right software on
your system in order to use "cvc cook" to build a package.

There are currently two major components to rMake: the rMake Server
and the rMake command line. The rMake Server runs as a daemon on your
system. It accepts rMake build jobs, creates build environments,
performs builds, and so on. The rMake command line controls the
server. Use it to create new build jobs, view a list of jobs, view
status and logs, and commit the resulting builds back to a Conary
repository.

%prep
%setup -q

%build
make libdir=%{_prefix}/lib

%install
rm -rf $RPM_BUILD_ROOT
make install libdir=%{_prefix}/lib initdir=%{_initrddir} DESTDIR=%{buildroot}
install -d %{buildroot}/%{_localstatedir}/lib/rmake
install -d %{buildroot}/%{_localstatedir}/log/rmake
install -d %{buildroot}/%{_localstatedir}/run/rmake
install -d %{buildroot}/%{_localstatedir}/rmake
install -d %{buildroot}/srv/rmake
install -d %{buildroot}/%{_sysconfdir}/rmake

%clean
rm -rf $RPM_BUILD_ROOT

%pre
/usr/sbin/useradd -M -o -r -d /srv/rmake -c "rMake Server" -u 201 rmake > /dev/null 2>&1 || :
/usr/sbin/useradd -M -o -r -d /srv/rmake -c "rMake Chroot Server" -u 202 rmake-chroot > /dev/null 2>&1 || :

%post
if [ $1 = 1 ] ; then
    /sbin/chkconfig --add rmake
fi

%preun
if [ $1 = 0 ] ; then
    /sbin/chkconfig --del rmake
fi

%postun
if [ $1 -ge 1 ] ; then
    /sbin/service rmake restart >/dev/null 2>&1 || :
fi
if [ $1 = 0 ] ; then
    /usr/sbin/userdel rmake >/dev/null 2>&1 || :
    /usr/sbin/userdel rmake-chroot >/dev/null 2>&1 || :
fi

%files
%defattr(-,root,root,-)
%doc NEWS
%attr(775,rmake,rmake) %dir %{_localstatedir}/lib/rmake
%attr(775,rmake,rmake) %dir %{_localstatedir}/log/rmake
%attr(775,rmake,rmake) %dir %{_localstatedir}/run/rmake
%attr(700,rmake,rmake) %dir %{_localstatedir}/rmake
%attr(775,rmake,rmake) %dir /srv/rmake
%dir %{_sysconfdir}/rmake
%dir %{_libexecdir}/rmake
%{_libexecdir}/rmake/rmake-xml
%attr(4755,root,rmake) %{_libexecdir}/rmake/chroothelper
%{pythonlib}
%{_bindir}/rmake
%{_sbindir}/rmake-server
%{_mandir}/man1/*
%{_mandir}/man8/*
%{_initrddir}/rmake

%changelog
* Wed Sep 13 2006 Cristian Gafton <gafton@gmail.com>
- fix permissions for /var/rmake

* Wed Jun 28 2006 Cristian Gafton <gafton@rpath.com>
- initial creation
