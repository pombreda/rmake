#
# Copyright (c) 2006-2007 rPath, Inc.  All Rights Reserved.
#

class RmakeRecipe(CPackageRecipe):
    name = 'rmake'
    version = '@ccsversion@'

    buildRequires = [ 'conary:python', 'chkconfig:runtime',
                      'info-rmake:user', 'info-rmake-chroot:user',
                      'libcap:devel',
                      'conary-repository:python', 'desktop-file-utils:runtime',
                      'pygtk:python', 'm2crypto:python', ]

    def setup(r):
        r.addArchive('rmake-@version@.tar.bz2')
        r.Make('libdir=%(libdir)s')
        r.MakeInstall('libdir=%(libdir)s')

        r.MakeDirs('%(localstatedir)s/lib/rmake')
        r.MakeDirs('%(localstatedir)s/log/rmake')
        r.MakeDirs('%(localstatedir)s/run/rmake')
        r.MakeDirs('%(localstatedir)s/rmake', mode=0700)
        r.MakeDirs('%(localstatedir)s/rmake/chroots', mode=0700)
        r.MakeDirs('%(localstatedir)s/rmake/archive', mode=0700)
        r.MakeDirs('%(servicedir)s/rmake')
        r.MakeDirs('%(sysconfdir)s/rmake')
        r.Desktopfile('extra/rmake.desktop')
        r.Ownership('rmake', 'rmake',
                    '%(localstatedir)s/rmake',
                    '%(localstatedir)s/rmake/chroots',
                    '%(localstatedir)s/rmake/archive',
                    '%(localstatedir)s/(lib|log|run)/rmake',
                    '%(servicedir)s/rmake',
                    '%(libexecdir)s/rmake')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/(lib|log|run)/rmake')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/rmake')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/rmake/chroots')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/rmake/archive')
        r.ExcludeDirectories(exceptions='%(servicedir)s/rmake')
        r.ExcludeDirectories(exceptions='%(sysconfdir)s/rmake')

        r.ComponentSpec('libexec', 'chroothelper')
        r.ComponentSpec('libexec', '%(localstatedir)s/rmake')
        r.ComponentSpec('libexec', '%(localstatedir)s/rmake/.*')
        r.ComponentSpec('libexec', '%(localstatedir)s/run/rmake')
        r.SetModes('%(libexecdir)s/rmake/chroothelper', 04755)
        r.Requires('rmake:libexec', 'rootfactory.py')
        r.Requires('busybox:runtime',
                   '%(libexecdir)s/rmake/chroothelper')
        r.Requires('openssl:runtime',
                   '%(libexecdir)s/rmake/gen-cert.sh')
        r.Requires('m2crypto:python', 'repos.py')
        r.Requires(exceptDeps='python: epdb')
        r.Requires(exceptDeps='python: rmake.cmdline.password')
        r.ComponentSpec('gtk', 'password.py(|c|o)')
        # make gtk require rmake:runtime
        r.ComponentRequires({'runtime' : ['gtk']})
        r.UtilizeUser('rmake-chroot', '%(libexecdir)s/rmake/chroothelper')
        r.UtilizeGroup('rmake-chroot', '%(libexecdir)s/rmake/chroothelper')
        r.Doc('extra/plugins/*.py')
        r.Copy('extra/plugins/monitor.py', '%(datadir)s/rmake/extra_plugins/')
